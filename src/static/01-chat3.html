<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width" />
        <script
            type="text/javascript"
            src="https://unpkg.com/colyseus.js@^0.15.0/dist/colyseus.js"
        ></script>
    </head>
    <body>
        <strong>客户端C</strong><br />

        <form id="form">
            <input type="text" id="input" value="" autofocus />
            <input type="submit" value="send" />
        </form>

        <div id="messages"></div>

        <script>
            var host = window.document.location.host.replace(/:.*/, "");
            const url =
                location.protocol.replace("http", "ws") +
                "//" +
                host +
                (location.port ? ":" + location.port : "");
            console.log(url); // ws://localhost:2567

            var client = new Colyseus.Client(url);

            // 使用 joinOrCreate 方法尝试加入名为 “chat” 的房间，如果该房间不存在，则创建它。一旦成功，会返回一个 room 对象，代表当前加入的房间。
            client.joinOrCreate("chat").then((room) => {
                console.log("joined");
                room.onStateChange.once(function (state) {
                    console.log("房间的初始状态:", state);
                });

                // new room state
                room.onStateChange(function (state) {
                    // this signal is triggered on each patch
                    console.log("房间的后续状态发生变化，状态:", state);
                });

                // listen to patches coming from the server
                // 接收并显示聊天消息
                room.onMessage("messages", function (message) {
                    console.log("收到消息message:", message);

                    var p = document.createElement("p");
                    p.innerText = message;
                    document.querySelector("#messages").appendChild(p);
                });

                // send message to room on submit
                // 发送聊天消息
                document.querySelector("#form").onsubmit = function (e) {
                    e.preventDefault();

                    var input = document.querySelector("#input");

                    console.log("input:", input.value);

                    // send data to room
                    room.send("message", input.value);
                    console.log("发送消息:", input.value);

                    // clear input
                    input.value = "";
                };
            });
        </script>
    </body>
</html>
